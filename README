# Linux Streaming Audio Setup #

This repository exists to guide in the setup and chaining of windows VSTs on Linux
without locking your system to an old version of Wine. These largely exist to remind me how to do this if I need to do it again and to collect the scripts I made to help me in doing so.

It is expected that you know a little about how to use the terminal and how to install packages from
your distribution's package manager and flatpaks from flathub.

The final steps also assume your distribution uses pipewire for audio (try `pipewire --version` in a terminal)

The scripts provided place symlinks for configuration and applications to this folder to make
editing and updating the scripts or configuration files easier. This means this folder needs to be
in a specific place and should not be removed.

## Step 1 - Required Software ##

* [yabridge](https://github.com/robbert-vdh/yabridge) - Wrapper to make Windows VSTs work under Linux
  * Install using the Ubuntu/Debian/Mint instructions
    * Obtain the [yabridge-5.1.1.tar.gz](https://github.com/robbert-vdh/yabridge/releases/download/5.1.1/yabridge-5.1.1.tar.gz) archive from the [releases page](https://github.com/robbert-vdh/yabridge/releases)
    * Extract the contents of the downloaded archive to `~/.local/share`, such that the file `~/.local/share/yabridge/yabridgectl` exists after extracting.
    * Don't use the Fedora COPR for these instructions/scripts

* [Bottles](https://flathub.org/en/apps/com.usebottles.bottles) - Wine environment manager
  * Install from the [flatpak](https://flathub.org/en/apps/com.usebottles.bottles)

* [Carla](https://kx.studio/Applications:Carla) - VST Host and audio routing
  * Fedora: `sudo dnf install Carla`
  * Fedora Atomic/Bazzite: `sudo rpm-ostree install Carla` (case sensitive)
    * Unfortunately in my experience the flatpak is unable to use the converted VSTs
    * The `brew` install failed connect to JACK for some reason
    * There may be a way other than layering to get this to work, but I haven't had any luck
    * It's possible the binaries from kx.studio may work but I haven't tried them yet

* [yq](https://github.com/mikefarah/yq) - Command line YAML parser (used to get details from the wine environment)
  * Fedora: `sudo dnf install yq`
  * Fedora Atomic: `sudo rpm-ostree install yq` (reboot required)
  * Bazzite: `brew install yq`

## Step 2 - Setting up the "Windows" environment and installing VSTs ##

In order for yabridge 5.1.1 to work you need a version of wine staging no later than 9.21[^1]. For this I'm using the 9.21-staging install from `Kron4ek` on the bottles runners list.

In Bottles:

* Open preferences (ctrl+,)
* On the 'Runners' tab, open the 'Kron4ek' dropdown
* Install "kron4ek-wine-9.21-staging-tkg-amd64"
* Create a new bottle
  * I've used `Application` as the base, it may not be necessary
  * Make sure the Runner is "kron4ek-wine-9.21-staging-tkg-amd64" and not a different runtime
* Install your VSTs into this newly created bottle through the UI
  * I would install a small set to check everything works, you can install more later if needed

## Step 3 - Setting up YABridge ##

Some files need to be in place for yabridge to work correctly.

* Edit the runtime_config/wineloader.conf file `YABRIDGE_WINE` value if you have used a different install location or wine runtime

* Run `./setup_scripts/yabridge_setup.py` to install the configuration file and script

* **Reboot or logout and log back in to complete installation**

* Run `./setup_scripts/yabridge_bottle_finder.py` to discover your VST folders

* Sync `yabridge` with your VSTs
  * run `yabridgectl sync`
  * You should see it list your VSTs

## Step 4 - Setting up an Audio Sink (Optional) (Requires pipewire) ##

This step adds a "desktop audio" device and a virtual "microphone" that can be used for routing audio in Carla.

* Run `./setup_scripts/setup_pipewire_sinks.py`
  * If your system does not use pipewire, this should fail with an error message
  * If you had some applications using audio, this will disconnect them in order to add the new virtual
    devices


## Step 5 - Route your audio and setup your VSTs

Load up Carla and add your plugins.

* Check in Settings -> Plugin Paths that paths with `/home/USERNAME/.vst` and `/home/USERNAME/.vst3` are included.
* You will have to work out which audio device represents your own hardware inputs/outputs.
* Use the patchbay to manage routing

After going through your effects chain, send the processed microphone to `microphone-vst-sink` and desktop audio to `processed-audio-vst-sink`.

Routing
```
Desktop Audio -> VST Routing -> processed-audio-vst-sink -> OBS
Microphone -> VST Routing -> microphone-vst-sink -> OBS
```

## Step 6 - Connect OBS ##

* Launch OBS, set desktop audio to `Desktop Audio VST Processing Sink`, microphone to `Microphone VST Processing Sink`


## Sources ##

* Original yabridge wineloader script
  * https://github.com/microfortnight/yabridge-bottles-wineloader
  * The script included here modifies this by adding a `YABRIDGE_WINE` environment variable
    that is used as if there is no system wine (such as on bazzite by default).
* Audio Sink Information
  * https://www.benashby.com/resources/pipewire-virtual-devices/
  * https://gitlab.freedesktop.org/pipewire/pipewire/-/wikis/Virtual-Devices#create-a-sink

[^1]: If you use a later version of Wine, your UI may not line up with your mouse cursor due to changes in rendering.

[^2]: The COPR repository will work for Fedora, but it pins your system Wine to an old version which is undesirable.
